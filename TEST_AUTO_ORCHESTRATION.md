# AI 自动编排测试指南

## 🎯 功能说明

现在 Claude-1 可以**自动**调用 Claude-2，无需人工干预！

### 工作原理

```
用户：只输入一次任务
  ↓
Claude-1：接收任务，自动分析需要哪些步骤
  ↓
Claude-1：输出 @claude-2: <子任务>
  ↓
系统：自动检测到调用，提取任务，发给 Claude-2
  ↓
Claude-2：处理任务并返回结果
  ↓
系统：自动将结果返回给 Claude-1
  ↓
Claude-1：基于 Claude-2 的结果继续工作
  ↓
(循环继续，直到 Claude-1 输出 [COMPLETE])
  ↓
系统：显示最终结果给用户
```

## 🚀 快速测试

### 测试1：简单任务（验证基础功能）

```bash
# 启动系统
bash start_minimal.sh --debug

# 输入简单任务
claude1> 写一个Python函数计算斐波那契数列第n项

# 观察：
# 1. Claude-1 是否输出 @claude-2: ...
# 2. 系统是否自动检测并调用 Claude-2
# 3. Claude-2 的响应是否自动返回给 Claude-1
# 4. Claude-1 是否继续处理
# 5. 最终是否输出 [COMPLETE] 标记
```

### 测试2：复杂任务（验证多轮协作）

```bash
claude1> 创建一个待办事项管理器，要求代码质量高且有完整的错误处理

# 预期行为：
# Round 1: Claude-1 分析任务
# Round 2: @claude-2: 写Python代码
# Round 3: Claude-2 生成代码
# Round 4: Claude-1 审查代码
# Round 5: @claude-2: 检查错误处理
# Round 6: Claude-2 提供改进建议
# Round 7: Claude-1 整合并输出 [COMPLETE]
```

### 测试3：手动控制（验证开关功能）

```bash
# 关闭自动编排
claude1> /auto off
❌ 自动编排模式已禁用

# 现在需要手动发送
claude1> 写一个函数
[只有 Claude-1 响应，不会自动调用 Claude-2]

# 重新开启
claude1> /auto on
✅ 自动编排模式已启用

# 再次测试
claude1> 写一个排序算法
[Claude-1 会自动调用 Claude-2]
```

## 📋 详细测试用例

### 用例1：数据处理任务

**输入:**
```
claude1> 写一个Python脚本来分析CSV文件，计算统计信息并生成图表
```

**预期输出:**
```
==================================================
📤 claude-1 响应:
==================================================
我会帮你完成这个任务。

@claude-2: 写一个Python脚本来分析CSV文件，包含以下功能：
1. 读取CSV文件
2. 计算基本统计信息（均值、中位数、标准差）
3. 生成可视化图表
==================================================

🔵 检测到调用: claude-2
   任务: 写一个Python脚本来分析CSV文件...

==================================================
📥 Claude-2 响应:
==================================================
[代码内容...]
==================================================

🔄 将响应返回给 Claude-1...

==================================================
📤 claude-1 响应:
==================================================
很好，让我检查一下代码质量...

@claude-2: 审查上面的代码，检查：
1. 错误处理是否完整
2. 是否处理了空CSV的情况
3. 图表生成的代码是否健壮
==================================================

[继续循环...]

✅ 任务完成！

==================================================
🎯 最终结果:
==================================================
这是完整的CSV分析脚本：
[最终代码]
==================================================
```

### 用例2：算法优化

**输入:**
```
claude1> 实现一个高效的字符串匹配算法
```

**预期流程:**
1. Claude-1 → @claude-2: 写初始版本
2. Claude-2 → 返回基础实现
3. Claude-1 → @claude-2: 分析时间复杂度
4. Claude-2 → 返回分析结果
5. Claude-1 → @claude-2: 优化性能
6. Claude-2 → 返回优化版本
7. Claude-1 → [COMPLETE] 最终结果

### 用例3：错误处理测试

**输入:**
```
claude1> 这是一个故意模糊的任务，看看你怎么处理
```

**预期行为:**
- Claude-1 应该尝试理解任务
- 如果无法处理，应该询问或给出合理响应
- 不应该无限循环

## 🔍 观察重点

### 1. 检测机制
- [ ] 系统能否准确检测 @claude-2: 标记
- [ ] 能否正确提取任务内容
- [ ] 多行任务是否正确处理

### 2. 路由机制
- [ ] 任务是否正确发送给 Claude-2
- [ ] Claude-2 的响应是否返回给 Claude-1
- [ ] 循环是否正常进行

### 3. 完成检测
- [ ] [COMPLETE] 标记是否被识别
- [ ] 最终结果是否正确提取
- [ ] 循环是否正常终止

### 4. 错误处理
- [ ] 达到最大循环次数时的行为
- [ ] Agent 不可用时的处理
- [ ] 输出为空时的处理

## 🐛 已知限制

1. **最大循环次数**: 10次（防止死循环）
2. **单向通信**: Claude-2 不能主动调用 Claude-1
3. **解析依赖**: 依赖 AI 输出正确的语法标记

## 📊 性能指标

记录测试数据：
```
测试任务: ________________
总循环次数: ___
成功完成: 是/否
总耗时: ___ 秒
Claude-1 调用次数: ___
Claude-2 响应次数: ___
```

## 🎓 进阶测试

### 测试嵌套任务
```bash
claude1> 创建一个完整的Web应用，包括前端、后端和数据库
```
观察 Claude-1 如何分解任务并协调 Claude-2

### 测试并发场景
```bash
claude1> 同时实现三个不同的排序算法并比较性能
```
观察如何处理多个子任务

### 压力测试
```bash
claude1> 创建一个包含10个微服务的系统架构
```
测试在复杂任务下的稳定性

## 💡 调试技巧

### 启用详细日志
```bash
python3 orchestrator_enhanced.py --debug
```

### 查看对话历史
```bash
claude1> /history
```

### 检查系统日志
```bash
tail -f orchestrator.log
```

## ✅ 成功标志

如果看到以下输出，说明功能正常：

```
🔵 检测到调用: claude-2
   任务: ...

==================================================
📥 Claude-2 响应:
==================================================
...

🔄 将响应返回给 Claude-1...

==================================================
📤 claude-1 响应:
==================================================
...

✅ 任务完成！

==================================================
🎯 最终结果:
==================================================
...
```

## 🚨 故障排查

### 问题1：Claude-1 不输出 @claude-2
**原因**: 可能没有理解协议
**解决**: 在提示中明确说明"可以使用 @claude-2 调用"

### 问题2：循环未终止
**原因**: Claude-1 没有输出 [COMPLETE]
**解决**: 手动按 Ctrl+C，或等待达到最大循环次数

### 问题3：检测失败
**原因**: 输出格式不匹配
**解决**: 查看 orchestrator.log 检查原始输出

---

**祝测试顺利！有任何问题随时查看日志或使用 /help 命令。** 🚀
